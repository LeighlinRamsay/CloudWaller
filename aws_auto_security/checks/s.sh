#!/usr/bin/env bash
set -euo pipefail

declare -A severity_map=(
  [accessanalyzer_enabled]=LOW
  [accessanalyzer_enabled_without_findings]=LOW
  [account_maintain_current_contact_details]=MEDIUM
  [account_maintain_different_contact_details_to_security_billing_and_operations]=MEDIUM
  [account_security_contact_information_is_registered]=MEDIUM
  [account_security_questions_are_registered_in_the_aws_account]=MEDIUM
  [acm_certificates_expiration_check]=HIGH
  [acm_certificates_transparency_logs_enabled]=MEDIUM
  [apigateway_restapi_authorizers_enabled]=MEDIUM
  [apigateway_restapi_client_certificate_enabled]=MEDIUM
  [apigateway_restapi_logging_enabled]=MEDIUM
  [apigateway_restapi_public]=MEDIUM
  [apigateway_restapi_public_with_authorizer]=MEDIUM
  [apigateway_restapi_waf_acl_attached]=MEDIUM
  [api_unprotected_endpoints]=HIGH
  [apigatewayv2_api_access_logging_enabled]=MEDIUM
  [apigatewayv2_api_authorizers_enabled]=MEDIUM
  [appstream_fleet_default_internet_access_disabled]=MEDIUM
  [appstream_fleet_maximum_session_duration]=MEDIUM
  [appstream_fleet_session_disconnect_timeout]=MEDIUM
  [appstream_fleet_session_idle_disconnect_timeout]=MEDIUM
  [beanstalk_aws_env_vars]=HIGH
  [cloudtrail]=CRITICAL
  [config_service]=CRITICAL
  [root_account_usage]=CRITICAL
  [privilege_escalation_invoke]=HIGH
  [cloudwatch_alarm_actions_disabled]=LOW
  [codebuild_env_secrets]=CRITICAL
  [cognito_identity_pool_unauth]=LOW
  [cognito_user_pool_client_mfa]=LOW
  [ebs_default_kms_key]=MEDIUM
  [ebs_unencrypted]=MEDIUM
  [orphaned_volumes]=LOW
  [required_tags]=LOW
  [snapshot_age_retention]=LOW
  [snapshot_cross_account]=HIGH
  [snapshot_public_exposed]=HIGH
  [snapshot_scheduling]=LOW
  [snapshot_unencrypted]=HIGH
  [tag_compliance]=LOW
  [ami_old_images]=LOW
  [ec2_mgmt_open_sgs]=CRITICAL
  [ecs_task_role_misuse]=MEDIUM
  [efs_mount_sg_public]=HIGH
  [storage_public_assets_restrictions]=HIGH
  [storage_public_code_assets]=HIGH
  [glue_job_privileges]=MEDIUM
  [glue_s3_public]=HIGH
  [guardduty_enabled]=LOW
  [admin_outside_break_glass]=HIGH
  [associate_profile_passrole]=LOW
  [attachvolume_permission]=MEDIUM
  [console_no_password_rotation]=MEDIUM
  [iam_create_access_key_limits]=MEDIUM
  [dangerous_iam]=HIGH
  [dangerous_iam_role_action]=HIGH
  [dangerous_iam_role_resource]=HIGH
  [ec2_role_permissive]=HIGH
  [efs_role_privileges]=MEDIUM
  [immutable_tag_enforcement]=LOW
  [mfa]=HIGH
  [iam_policy_version_mgmt]=MEDIUM
  [ssm_root_permissions]=CRITICAL
  [unused_access_keys]=LOW
  [users_not_in_groups]=LOW
  [wildcard_trust]=HIGH
  [lambda_no_timeout]=MEDIUM
  [lambda_role_misuse]=MEDIUM
  [ec2_not_in_asg]=LOW
  [ec2_public_ips]=LOW
  [flow_logs]=LOW
  [http_public_exposed]=LOW
  [alb_metadata_service_access]=LOW
  [nacl]=LOW
  [open_sgs]=LOW
  [situation_sg]=LOW
  [wafless_app_ports]=LOW
  [hardcoded_secrets]=CRITICAL
  [rds_non_admin_snapshot_misuse]=HIGH
  [rds_public_access]=CRITICAL
  [rds_subnet_group_public]=HIGH
  [rds_unencrypted_or_wildcard_shared_snapshots]=HIGH
  [block_public_access_disabled]=LOW
  [public_s3]=LOW
  [s3_encryption_at_rest]=LOW
  [s3_logging_disabled]=LOW
  [s3_missing_versioning]=LOW
  [s3_open_bucket_policy]=LOW
  [secretsmanager_wildcard]=HIGH
  [sns_topic_policy]=LOW
)

find . -type f -path '*/*/metadata.json' | while read -r file; do
  id=$(jq -r '.id' "$file")
  sev=${severity_map[$id]:-MEDIUM}
  tmp=$(mktemp)
  jq --arg s "$sev" '.severity = $s' "$file" > "$tmp" && mv "$tmp" "$file"
  echo "Updated $file â†’ severity=$sev"
done
